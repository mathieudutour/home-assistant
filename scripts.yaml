vacuum_clean_segments:
  sequence:
    - service: script.turn_on
      target:
        entity_id: script.vacuum_clean_segments_message
      data:
        variables:
          segments: |
            {{ [
              {'id': '2', 'state': states('input_boolean.vacuum_selected_room_cuisine')},
              {'id': '4', 'state': states('input_boolean.vacuum_selected_room_salon')},
              {'id': '1', 'state': states('input_boolean.vacuum_selected_room_cellier')},
              {'id': '5', 'state': states('input_boolean.vacuum_selected_room_entree')},
              {'id': '3', 'state': states('input_boolean.vacuum_selected_room_wc_r0')}
              ] | selectattr('state', 'eq', 'on') | map(attribute='id') | list | to_json }}
  mode: single
  alias: vacuum_clean_segments
  icon: mdi:arrow-right
vacuum_clean_segments_message:
  alias: vacuum_clean_segments_message
  sequence:
    - service: mqtt.publish
      data:
        topic: valetudo/R2D2/MapSegmentationCapability/clean/set
        payload_template: '{"segment_ids": {{segments}}}'
  mode: single
