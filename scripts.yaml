vacuum_clean_segments:
  sequence:
    - service: script.turn_on
      target:
        entity_id: script.vacuum_clean_segments_message
      data:
        variables:
          segments: "{{ state_attr('group.vacuum_selected_rooms', 'entity_id') | select('is_state', 'on') | map('state_attr', 'room_id') | list | to_json }}"
  mode: single
  alias: vacuum_clean_segments
  icon: mdi:arrow-right
vacuum_clean_segments_message:
  alias: vacuum_clean_segments_message
  sequence:
    - service: mqtt.publish
      data:
        topic: valetudo/R2D2/MapSegmentationCapability/clean/set
        payload_template: '{"segment_ids": {{segments}}}'
  mode: single
